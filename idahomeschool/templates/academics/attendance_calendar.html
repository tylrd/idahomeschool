{% extends "academics/base.html" %}
{% load static %}

{% block title %}Attendance Calendar{% endblock %}

{% block academics_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Attendance Calendar</h1>
  <div>
    <a href="{% url 'academics:dailylog_entry' %}" class="btn btn-success">Log Attendance</a>
    <a href="{% url 'academics:attendance_report' %}" class="btn btn-outline-primary">View Report</a>
  </div>
</div>

<!-- View Type and Navigation -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row align-items-center">
      <div class="col-md-4">
        <div class="btn-group" role="group">
          <a href="?view=week&date={{ ref_date|date:'Y-m-d' }}" class="btn btn-outline-primary {% if view_type == 'week' %}active{% endif %}">Week</a>
          <a href="?view=month&date={{ ref_date|date:'Y-m-d' }}" class="btn btn-outline-primary {% if view_type == 'month' %}active{% endif %}">Month</a>
        </div>
      </div>
      <div class="col-md-4 text-center">
        <h5 class="mb-0">
          {% if view_type == 'week' %}
            Week of {{ start_date|date:"F j" }} - {{ end_date|date:"j, Y" }}
          {% else %}
            {{ ref_date|date:"F Y" }}
          {% endif %}
        </h5>
      </div>
      <div class="col-md-4 text-end">
        <div class="btn-group" role="group">
          <a href="?view={{ view_type }}&date={{ prev_date }}" class="btn btn-outline-secondary">← Previous</a>
          <a href="?view={{ view_type }}" class="btn btn-outline-primary">Today</a>
          <a href="?view={{ view_type }}&date={{ next_date }}" class="btn btn-outline-secondary">Next →</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Attendance Grid -->
<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>Student</th>
            {% for d in date_range %}
              <th class="text-center {% if d == ref_date %}table-primary{% endif %}">
                <div>{{ d|date:"D" }}</div>
                <div><small>{{ d|date:"M j" }}</small></div>
              </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in attendance_grid %}
          <tr>
            <td>
              <strong>{{ row.student.name }}</strong><br>
              <small class="text-muted">Grade {{ row.student.grade_level }}</small>
            </td>
            {% for date_info in row.dates %}
              <td class="text-center attendance-cell {% if date_info.date == ref_date %}table-light{% endif %}"
                  data-student-id="{{ row.student.id }}"
                  data-date="{{ date_info.date|date:'Y-m-d' }}"
                  style="position: relative;">
                {% include "academics/partials/status_badge.html" with student=row.student date_str=date_info.date|date:'Y-m-d' log=date_info.log has_notes=date_info.has_notes %}
              </td>
            {% endfor %}
          </tr>
          {% empty %}
          <tr>
            <td colspan="{{ date_range|length|add:1 }}" class="text-center">
              <p class="mb-0 text-muted">No students found.</p>
              <a href="{% url 'academics:student_create' %}" class="btn btn-sm btn-primary mt-2">Add First Student</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Legend and Keyboard Shortcuts -->
<div class="row mt-3">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h6>Legend:</h6>
        <div class="row">
          <div class="col-auto">
            <span class="badge bg-success">P</span> Present
          </div>
          <div class="col-auto">
            <span class="badge bg-danger">A</span> Absent
          </div>
          <div class="col-auto">
            <span class="badge bg-warning">S</span> Sick
          </div>
          <div class="col-auto">
            <span class="badge bg-info">H</span> Holiday
          </div>
          <div class="col-auto">
            <span class="badge bg-primary">F</span> Field Trip
          </div>
          <div class="col-auto">
            <span class="text-muted">-</span> No log
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h6>Keyboard Shortcuts:</h6>
        <div class="keyboard-shortcuts">
          <div><kbd>←</kbd> <kbd>→</kbd> <kbd>↑</kbd> <kbd>↓</kbd> Navigate grid</div>
          <div><kbd>1</kbd>-<kbd>5</kbd> Quick set status (Present/Absent/Sick/Holiday/Field Trip)</div>
          <div><kbd>Space</kbd> Toggle batch mode</div>
          <div><kbd>Esc</kbd> Close dropdown/modal</div>
          <div class="mt-2 small text-muted">
            <strong>Batch Mode:</strong> Click to select, Shift+Click for range, Ctrl/Cmd+Click to toggle
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- HTMX Containers -->
<div id="status-selector-container" style="position: fixed; z-index: 1060;"></div>
<div id="course-notes-modal-container"></div>

<!-- HTMX Event Handlers -->
<script>
  // Close dropdown when closeDropdown event is triggered
  document.body.addEventListener('closeDropdown', function() {
    document.getElementById('status-selector-container').innerHTML = '';
  });

  // Position status selector dropdown next to clicked badge
  document.body.addEventListener('htmx:beforeSwap', function(event) {
    if (event.detail.target.id === 'status-selector-container') {
      // Get the clicked element position
      const clickedElement = event.detail.requestConfig.elt;
      const rect = clickedElement.getBoundingClientRect();
      const container = document.getElementById('status-selector-container');

      // Position dropdown near the clicked badge
      container.style.left = (rect.left + window.scrollX) + 'px';
      container.style.top = (rect.bottom + window.scrollY + 5) + 'px';
    }
  });
</script>

<!-- Attendance Grid Advanced Features -->
<script src="{% static 'js/attendance-grid.js' %}" defer></script>

<!-- Bootstrap Icons CDN for note icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

{% endblock academics_content %}
