{% extends "academics/base.html" %}
{% load static %}

{% block title %}Attendance Calendar{% endblock %}

{% block academics_content %}
<div x-data="{
  currentDate: new Date('{{ ref_date|date:"Y-m-d" }}'),
  selectedStudent: {{ selected_student_id|default:'null' }},

  get weekRange() {
    const start = new Date(this.currentDate);
    start.setDate(start.getDate() - start.getDay()); // Go to Sunday
    const end = new Date(start);
    end.setDate(end.getDate() + 6); // Go to Saturday

    const startStr = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    const endStr = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    return `${startStr} - ${endStr}`;
  },

  prevWeek() {
    this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), this.currentDate.getDate() - 7);
    this.loadWeekData();
  },

  nextWeek() {
    this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), this.currentDate.getDate() + 7);
    this.loadWeekData();
  },

  today() {
    this.currentDate = new Date();
    this.loadWeekData();
  },

  loadWeekData() {
    const params = new URLSearchParams({
      date: this.currentDate.toISOString().split('T')[0],
      view: 'week'
    });
    if (this.selectedStudent) {
      params.append('student', this.selectedStudent);
    }
    htmx.ajax('GET', '{% url "academics:attendance_calendar" %}?' + params.toString(), {
      target: '#calendar-grid',
      swap: 'innerHTML'
    });
  }
}">

  <!-- Page Header -->
  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
    <h1 class="text-3xl font-bold tracking-tight">Attendance Calendar</h1>
    <div class="flex gap-2">
      <a href="{% url 'academics:attendance_report' %}" class="btn-outline">
        <i data-lucide="file-text"></i> Report
      </a>
      <a href="{% url 'academics:attendance_status_list' %}" class="btn-outline">
        <i data-lucide="settings"></i> Settings
      </a>
    </div>
  </div>

  <!-- Controls Bar -->
  <div class="mb-6 p-4 border rounded-lg bg-muted/20">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

      <!-- Week Navigation -->
      <div class="flex items-center gap-2">
        <button @click="prevWeek" class="btn-icon-outline size-9" aria-label="Previous week">
          <i data-lucide="chevron-left"></i>
        </button>

        <div class="flex-1 text-center">
          <h2 class="text-base sm:text-lg font-semibold" x-text="weekRange"></h2>
        </div>

        <button @click="nextWeek" class="btn-icon-outline size-9" aria-label="Next week">
          <i data-lucide="chevron-right"></i>
        </button>

        <button @click="today" class="btn-outline whitespace-nowrap">
          <i data-lucide="calendar"></i> <span class="hidden sm:inline">Today</span>
        </button>
      </div>

      <!-- Student Filter -->
      <div class="grid gap-2">
        <label for="student-filter" class="text-sm font-medium sr-only">Filter by Student</label>
        <select id="student-filter"
                x-model="selectedStudent"
                @change="loadWeekData()"
                class="w-full">
          <option value="">All Students</option>
          {% for student in students %}
          <option value="{{ student.id }}" {% if selected_student_id == student.id %}selected{% endif %}>
            {{ student.name }}
          </option>
          {% endfor %}
        </select>
      </div>

    </div>
  </div>

  <!-- Calendar Grid Container -->
  <div id="calendar-grid" class="mb-6">
    {% include "academics/partials/calendar_week_grid.html" %}
  </div>

  <!-- Legend -->
  <div class="border rounded-lg p-4">
    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
      <i data-lucide="info" class="size-4"></i>
      Status Legend
    </h3>
    <div class="flex flex-wrap gap-3">
      {% for status in attendance_statuses %}
      <div class="flex items-center gap-2">
        <span class="badge px-3 py-1.5 min-w-[40px] text-center font-semibold"
              style="background-color: {{ status.color }}; {% if status.color|slice:':4' == '#ffc' or status.color|slice:':4' == '#ff0' or status.color|slice:':4' == '#fff' %}color: #000;{% endif %}">
          {{ status.abbreviation }}
        </span>
        <span class="text-sm text-muted-foreground">{{ status.label }}</span>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Quick Actions (Mobile Optimized) -->
  <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
    <a href="{% url 'academics:dailylog_entry' %}" class="btn">
      <i data-lucide="plus-circle"></i> Log Today's Attendance
    </a>
    <a href="{% url 'academics:dailylog_list' %}" class="btn-outline">
      <i data-lucide="list"></i> View All Logs
    </a>
  </div>

</div>

<!-- Modal Containers (for HTMX-loaded modals) -->
<div id="status-selector-container"></div>
<div id="course-notes-modal-container"></div>

<!-- Script for closing status selector on HX-Trigger -->
<script>
  document.body.addEventListener('closeDropdown', function() {
    document.getElementById('status-selector-container').innerHTML = '';
  });

  // Function to open course notes modal from status selector
  function openCourseNotesFromModal(button) {
    const url = button.dataset.courseNotesUrl;
    // Close status selector first
    document.getElementById('status-selector-container').innerHTML = '';

    // Wait a moment, then load course notes modal
    setTimeout(() => {
      htmx.ajax('GET', url, {
        target: '#course-notes-modal-container',
        swap: 'innerHTML'
      });
    }, 100);
  }
</script>

{% endblock academics_content %}
