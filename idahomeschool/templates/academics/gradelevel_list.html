{% extends "academics/base.html" %}
{% load static %}

{% block title %}Grade Levels{% endblock %}

{% block academics_content %}
<div class="flex justify-between items-center mb-6">
  <h1 class="text-3xl font-bold tracking-tight">Grade Levels</h1>
  <div class="flex gap-2">
    <a href="{% url 'academics:gradelevel_create' %}" class="btn-outline">
      <i data-lucide="plus-circle"></i> Add Grade Level
    </a>
  </div>
</div>

{% if grade_levels %}
<div class="relative w-full overflow-x-auto">
  <table class="table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Order</th>
        <th>Description</th>
        <th class="text-right">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for grade in grade_levels %}
      <tr id="gradelevel-row-{{ grade.pk }}">
        <td>
          <a href="{% url 'academics:gradelevel_detail' grade.pk %}" class="link font-medium">{{ grade.name }}</a>
        </td>
        <td class="text-muted-foreground">{{ grade.order }}</td>
        <td class="text-muted-foreground">{{ grade.description|truncatewords:10 }}</td>
        <td>
          <div class="flex gap-1 justify-end">
            <button type="button"
                    onclick="document.getElementById('dialog-edit-{{ grade.pk }}').showModal()"
                    class="btn-icon-outline size-8">
              <i data-lucide="pencil"></i>
            </button>
            <button type="button"
                    onclick="document.getElementById('dialog-delete-{{ grade.pk }}').showModal()"
                    class="btn-icon-outline size-8 text-destructive hover:bg-destructive/10">
              <i data-lucide="trash-2"></i>
            </button>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

  <!-- Dialogs - placed outside table structure -->
  {% for grade in grade_levels %}
    <!-- Edit Dialog -->
    <dialog id="dialog-edit-{{ grade.pk }}"
            class="dialog w-full sm:max-w-[500px]"
            aria-labelledby="dialog-edit-{{ grade.pk }}-title"
            onclick="if (event.target === this) this.close()">
      <div>
        <header>
          <h2 id="dialog-edit-{{ grade.pk }}-title">Edit Grade Level</h2>
          <p>Update the details for {{ grade.name }}.</p>
        </header>

        <form hx-post="{% url 'academics:gradelevel_update' grade.pk %}"
              hx-target="#gradelevel-row-{{ grade.pk }}"
              hx-swap="outerHTML"
              hx-on::after-request="if(event.detail.successful) this.closest('dialog').close()"
              class="form">
          {% csrf_token %}

          <section class="space-y-4">
            <div class="grid gap-2">
              <label for="edit-name-{{ grade.pk }}" class="text-sm font-medium">Name</label>
              <input type="text" name="name" id="edit-name-{{ grade.pk }}" value="{{ grade.name }}" required>
            </div>

            <div class="grid gap-2">
              <label for="edit-order-{{ grade.pk }}" class="text-sm font-medium">Order</label>
              <input type="number" name="order" id="edit-order-{{ grade.pk }}" value="{{ grade.order }}" required>
              <p class="text-muted-foreground text-sm">Numeric order for sorting (e.g., 0 for PK, 1 for K, 2 for 1st)</p>
            </div>

            <div class="grid gap-2">
              <label for="edit-description-{{ grade.pk }}" class="text-sm font-medium">Description</label>
              <textarea name="description" id="edit-description-{{ grade.pk }}" rows="3">{{ grade.description }}</textarea>
            </div>
          </section>

          <footer class="mt-4">
            <button type="button" class="btn-outline" onclick="this.closest('dialog').close()">Cancel</button>
            <button type="button"
                    class="btn"
                    onclick="this.closest('dialog').querySelector('form').requestSubmit()">
              Save changes
            </button>
          </footer>
        </form>

        <button type="button" aria-label="Close dialog" onclick="this.closest('dialog').close()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x">
            <path d="M18 6 6 18" />
            <path d="m6 6 12 12" />
          </svg>
        </button>
      </div>
    </dialog>

    <!-- Delete Dialog -->
    <dialog id="dialog-delete-{{ grade.pk }}"
            class="dialog w-full sm:max-w-[425px]"
            aria-labelledby="dialog-delete-{{ grade.pk }}-title"
            aria-describedby="dialog-delete-{{ grade.pk }}-description"
            onclick="if (event.target === this) this.close()">
      <div>
        <header>
          <h2 id="dialog-delete-{{ grade.pk }}-title">Delete Grade Level</h2>
          <p id="dialog-delete-{{ grade.pk }}-description">Are you sure you want to delete {{ grade.name }}?</p>
        </header>

        <section>
          <div class="mb-6 p-4 border-l-4 border-red-600 bg-red-50 dark:bg-red-900/20">
            <div class="flex items-start gap-3">
              <i data-lucide="alert-triangle" class="size-5 text-red-600 shrink-0 mt-0.5"></i>
              <div>
                <h4 class="font-semibold text-red-900 dark:text-red-200">Warning</h4>
                <p class="text-sm text-red-800 dark:text-red-300 mt-1">
                  This will also delete all associated courses. This action cannot be undone.
                </p>
              </div>
            </div>
          </div>
        </section>

        <footer>
          <button type="button" class="btn-outline" onclick="this.closest('dialog').close()">Cancel</button>
          <form method="post"
                action="{% url 'academics:gradelevel_delete' grade.pk %}"
                hx-post="{% url 'academics:gradelevel_delete' grade.pk %}"
                hx-target="#gradelevel-row-{{ grade.pk }}"
                hx-swap="outerHTML swap:1s"
                style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn bg-destructive hover:bg-destructive/90">Delete</button>
          </form>
        </footer>

        <button type="button" aria-label="Close dialog" onclick="this.closest('dialog').close()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x">
            <path d="M18 6 6 18" />
            <path d="m6 6 12 12" />
          </svg>
        </button>
      </div>
    </dialog>
  {% endfor %}

{% else %}
<div class="p-12 text-center">
  <div class="mx-auto flex max-w-md flex-col items-center gap-2">
    <div class="flex size-12 items-center justify-center rounded-full bg-muted">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-muted-foreground">
        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
    </div>
    <h2 class="text-xl font-semibold">No grade levels found</h2>
    <p class="text-sm text-muted-foreground mb-2">Create grade levels to organize your students and courses by grade.</p>
    <div class="flex gap-2">
      <a href="{% url 'academics:gradelevel_create' %}" class="btn">
        <i data-lucide="plus-circle"></i> Create Grade Level
      </a>
      <form method="post" action="{% url 'academics:gradelevel_create_pk12' %}" class="inline">
        {% csrf_token %}
        <button type="submit" class="btn-outline">
          <i data-lucide="list-ordered"></i> Create PK-12 Grades
        </button>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock academics_content %}
