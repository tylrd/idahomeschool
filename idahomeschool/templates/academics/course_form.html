{% extends "academics/base.html" %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Add{% endif %} Course{% endblock %}

{% block academics_content %}
<div class="mb-6">
  <h1 class="text-3xl font-bold tracking-tight">{% if form.instance.pk %}Edit{% else %}Add{% endif %} Course</h1>
</div>

<form method="post" class="form space-y-6">
      {% csrf_token %}

      <div class="grid gap-2">
        <label for="{{ form.name.id_for_label }}" class="text-sm font-medium">{{ form.name.label }}</label>
        <input type="text" name="{{ form.name.name }}" class="{% if form.name.errors %}border-destructive{% endif %}"
               id="{{ form.name.id_for_label }}" value="{{ form.name.value|default:'' }}" required>
        {% if form.name.errors %}
          <p class="text-destructive text-sm">{{ form.name.errors.0 }}</p>
        {% endif %}
      </div>

      <div class="grid gap-2">
        <label for="{{ form.grade_level.id_for_label }}" class="text-sm font-medium">{{ form.grade_level.label }}</label>
        <select name="{{ form.grade_level.name }}" class="{% if form.grade_level.errors %}border-destructive{% endif %}"
                id="{{ form.grade_level.id_for_label }}">
          <option value="">--------- (Grade-agnostic)</option>
          {% for choice in form.fields.grade_level.queryset %}
            <option value="{{ choice.id }}"
                    {% if form.grade_level.value == choice.id|stringformat:"s" %}selected{% endif %}>
              {{ choice.name }}
            </option>
          {% endfor %}
        </select>
        {% if form.grade_level.help_text %}
          <p class="text-muted-foreground text-sm">{{ form.grade_level.help_text }}</p>
        {% endif %}
        {% if form.grade_level.errors %}
          <p class="text-destructive text-sm">{{ form.grade_level.errors.0 }}</p>
        {% endif %}
      </div>

      <div class="grid gap-2">
        <label for="{{ form.course_template.id_for_label }}" class="text-sm font-medium">{{ form.course_template.label }}</label>
        <select name="{{ form.course_template.name }}" class="{% if form.course_template.errors %}border-destructive{% endif %}"
                id="{{ form.course_template.id_for_label }}" data-template-select>
          <option value="">---------</option>
          {% for choice in form.fields.course_template.queryset %}
            <option value="{{ choice.id }}"
                    {% if form.course_template.value == choice.id|stringformat:"s" %}selected{% endif %}
                    data-resources="{% for resource in choice.suggested_resources.all %}{{ resource.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
              {{ choice.name }}
            </option>
          {% endfor %}
        </select>
        {% if form.course_template.help_text %}
          <p class="text-muted-foreground text-sm">{{ form.course_template.help_text }}</p>
        {% endif %}
        {% if form.course_template.errors %}
          <p class="text-destructive text-sm">{{ form.course_template.errors.0 }}</p>
        {% endif %}
      </div>

      <div class="grid gap-2">
        <label for="{{ form.description.id_for_label }}" class="text-sm font-medium">{{ form.description.label }}</label>
        <textarea name="{{ form.description.name }}" class="{% if form.description.errors %}border-destructive{% endif %}"
                  id="{{ form.description.id_for_label }}" rows="3">{{ form.description.value|default:'' }}</textarea>
        {% if form.description.errors %}
          <p class="text-destructive text-sm">{{ form.description.errors.0 }}</p>
        {% endif %}
      </div>

      <div class="grid gap-2">

        <!-- Currently Selected Resources -->
        {% if form.instance.pk %}
        <div class="mb-2">
          <strong>Currently Selected:</strong>
          <div id="selected-resources-display" class="mt-1">
            {% for resource in form.instance.resources.all %}
              <span class="badge bg-info me-1">{{ resource.title }}</span>
            {% empty %}
              <span class="text-muted-foreground">None</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Tag Filter UI -->
        <div class="mb-2">
          <div id="tag-filter-container">
            {% load static %}
            {% comment %}Tags will be loaded here via JavaScript{% endcomment %}
            <p class="text-muted-foreground text-sm mb-0">Loading tags...</p>
          </div>
        </div>

        <!-- Search input with Create button -->
        <div class="flex gap-2 mb-2">
          <input
            type="text"
            id="resource-search-input"
            name="search"
            class="flex-1"
            placeholder="Search resources by title, author, or publisher..."
            hx-get="{% url 'academics:resource_search_htmx' %}?field_name=resources"
            hx-trigger="keyup changed delay:300ms, load"
            hx-target="#resource-search-results-resources"
            hx-include="#selected-resources-container, #tag-filter-inputs"
          >
          <button
            type="button"
            class="btn"
            id="create-resource-btn"
            hx-get="{% url 'academics:resource_create_modal_htmx' %}?field_name=resources"
            hx-target="#modal-container"
            hx-swap="innerHTML"
          >
            <i data-lucide="plus-circle"></i> Create New Resource
          </button>
        </div>

        <!-- Hidden container for selected resource IDs -->
        <div id="selected-resources-container" style="display: none;">
          <input type="hidden" name="selected_ids" value="{% if form.instance.pk %}{% for resource in form.instance.resources.all %}{{ resource.id }}{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}" id="selected-ids-input">
        </div>

        <!-- Hidden container for tag filter IDs -->
        <div id="tag-filter-inputs" style="display: none;"></div>

        <div id="resource-search-results-resources" style="max-height: 400px; overflow-y: auto;">
          <p class="text-muted-foreground">Type to search for resources...</p>
        </div>
        <p class="text-muted-foreground text-sm">Search and select resources for this course. Use tag filters to narrow results.</p>
        {% if form.resources.errors %}
          <p class="text-destructive text-sm">{{ form.resources.errors }}</p>
        {% endif %}
      </div>

      <style>
        /* Tag filter hover effect */
        .tag-filter-btn {
          background: transparent;
          cursor: pointer;
        }
        .tag-filter-btn:hover {
          opacity: 1 !important;
          transform: scale(1.05);
        }
      </style>

      <script>
        let selectedTagIds = [];
        let isSearching = false; // Guard against infinite loops

        // Update selected IDs when checkboxes change
        document.addEventListener('htmx:afterSwap', function(event) {
          if (event.detail.target.id === 'resource-search-results-resources') {
            isSearching = false; // Reset guard after search completes
            const checkboxes = document.querySelectorAll('.resource-checkbox');
            checkboxes.forEach(checkbox => {
              checkbox.addEventListener('change', updateSelectedIds);
            });
          }
        });

        function updateSelectedIds() {
          const checkboxes = document.querySelectorAll('.resource-checkbox:checked');
          const ids = Array.from(checkboxes).map(cb => cb.value).join(',');
          document.getElementById('selected-ids-input').value = ids;

          // Don't trigger a search - just update the hidden input
          // The search will include these IDs when triggered by other actions
        }

        function triggerResourceSearch() {
          if (isSearching) {
            return; // Prevent infinite loop
          }

          isSearching = true;
          const searchInput = document.getElementById('resource-search-input');

          // Get the URL from the hx-get attribute
          const url = searchInput.getAttribute('hx-get');
          const searchQuery = searchInput.value;
          const selectedIds = document.getElementById('selected-ids-input').value;

          // Get tag IDs from hidden inputs
          const tagInputs = document.querySelectorAll('#tag-filter-inputs input[name="tag_ids[]"]');
          const tagIds = Array.from(tagInputs).map(input => input.value);

          // Use htmx.ajax to make the request with proper parameters
          htmx.ajax('GET', url, {
            target: '#resource-search-results-resources',
            swap: 'innerHTML',
            values: {
              search: searchQuery,
              selected_ids: selectedIds,
              field_name: 'resources',
              'tag_ids[]': tagIds
            }
          });
        }

        // Auto-populate resources when course template is selected
        document.addEventListener('DOMContentLoaded', function() {
          loadTagFilters();

          // Use event delegation for tag filter buttons
          const tagFilterContainer = document.getElementById('tag-filter-container');
          if (tagFilterContainer) {
            tagFilterContainer.addEventListener('click', function(e) {
              // Handle tag filter button clicks
              const tagButton = e.target.closest('.tag-filter-btn');
              if (tagButton) {
                const tagId = parseInt(tagButton.getAttribute('data-tag-id'));
                const tagName = tagButton.getAttribute('data-tag-name');
                const tagColor = tagButton.getAttribute('data-tag-color');
                toggleTagFilter(tagId, tagName, tagColor);
                return;
              }

              // Handle clear filters button
              if (e.target.closest('#clear-tag-filters')) {
                selectedTagIds = [];
                updateTagFilterInputs();
                updateTagFilterDisplay();
                triggerResourceSearch();
              }
            });
          }
        });

        function loadTagFilters() {
          // Fetch all tags for this user
          fetch('/academics/tags/autocomplete/?search=', {
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => response.json())
          .then(data => {
            renderTagFilters(data.tags || []);
          })
          .catch(error => {
            console.error('Error loading tags:', error);
          });
        }

        function renderTagFilters(tags) {
          const container = document.getElementById('tag-filter-container');
          let html = '';

          if (tags.length === 0) {
            html = '<p class="text-muted small mb-0">No tags available. <a href="/academics/tags/create/">Create a tag</a> to filter resources.</p>';
          } else {
            html += '<div class="flex flex-wrap gap-2 items-center">';
            tags.forEach(tag => {
              html += `
                <button type="button"
                        class="tag-filter-btn px-3 py-1 rounded-full border-2 transition-all"
                        style="border-color: ${tag.color}; background-color: ${tag.color}20; color: hsl(var(--foreground));"
                        data-tag-id="${tag.id}"
                        data-tag-name="${escapeHtml(tag.name)}"
                        data-tag-color="${tag.color}">
                  ${escapeHtml(tag.name)}
                </button>
              `;
            });

            html += `
              <button type="button" class="btn btn-sm" id="clear-tag-filters">
                <i data-lucide="x-circle"></i> Clear Filters
              </button>
            `;
            html += '</div>';
          }

          container.innerHTML = html;
        }

        function toggleTagFilter(tagId, tagName, tagColor) {
          const index = selectedTagIds.indexOf(tagId);

          if (index > -1) {
            // Remove tag from filters
            selectedTagIds.splice(index, 1);
          } else {
            // Add tag to filters
            selectedTagIds.push(tagId);
          }

          updateTagFilterInputs();
          updateTagFilterDisplay();
          triggerResourceSearch();
        }

        function clearTagFilters() {
          selectedTagIds = [];
          updateTagFilterInputs();
          updateTagFilterDisplay();
          triggerResourceSearch();
        }

        function updateTagFilterInputs() {
          const container = document.getElementById('tag-filter-inputs');
          container.innerHTML = '';

          selectedTagIds.forEach(tagId => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'tag_ids[]';
            input.value = tagId;
            container.appendChild(input);
          });
        }

        function updateTagFilterDisplay() {
          const buttons = document.querySelectorAll('.tag-filter-btn');
          buttons.forEach(button => {
            const tagId = parseInt(button.getAttribute('data-tag-id'));
            const tagColor = button.getAttribute('data-tag-color');

            if (selectedTagIds.includes(tagId)) {
              // Selected: fill with solid color
              button.style.backgroundColor = tagColor;
              button.style.color = getContrastColor(tagColor);
              button.style.opacity = '1';
            } else {
              // Not selected: light tint background
              button.style.backgroundColor = tagColor + '20';
              button.style.color = 'hsl(var(--foreground))';
              button.style.opacity = '0.8';
            }
          });
        }

        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        function getContrastColor(hexColor) {
          // Remove # if present
          const hex = hexColor.replace('#', '');

          // Convert to RGB
          const r = parseInt(hex.substr(0, 2), 16);
          const g = parseInt(hex.substr(2, 2), 16);
          const b = parseInt(hex.substr(4, 2), 16);

          // Calculate luminance
          const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

          // Return black or white based on luminance
          return luminance > 0.5 ? '#000000' : '#ffffff';
        }
      </script>

      <div class="flex gap-2">
        <button type="submit" class="btn">
          <i data-lucide="save"></i> Save Course
        </button>
        <a href="{% url 'academics:course_list' %}" class="btn-outline">
          <i data-lucide="x"></i> Cancel
        </a>
      </div>
    </form>

<!-- Dialog Container -->
<dialog id="resource-create-dialog" class="dialog w-full sm:max-w-2xl max-h-[90vh]" aria-labelledby="resource-create-dialog-title" onclick="if (event.target === this) this.close()">
  <div id="resource-dialog-content">
    <!-- Content will be loaded via HTMX -->
  </div>
</dialog>

<script>
  // Handle dialog show/hide and resource creation
  const resourceDialog = document.getElementById('resource-create-dialog');

  // Show dialog after HTMX loads content
  document.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'resource-dialog-content') {
      resourceDialog.showModal();
    }

    // Handle successful resource creation
    if (event.detail.target.id === 'resource-search-results-resources') {
      // Close dialog if it's open
      if (resourceDialog.open) {
        resourceDialog.close();
        // Clear dialog content after closing
        setTimeout(() => {
          document.getElementById('resource-dialog-content').innerHTML = '';
        }, 300);
      }

      // Re-attach event listeners to checkboxes and update selected IDs
      const checkboxes = document.querySelectorAll('.resource-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedIds);
      });

      // Update the hidden input with currently checked values
      updateSelectedIds();
    }
  });

  // Update Create button to include selected_ids in URL
  document.addEventListener('DOMContentLoaded', function() {
    const createBtn = document.getElementById('create-resource-btn');
    if (createBtn) {
      createBtn.addEventListener('click', function() {
        const selectedIds = document.getElementById('selected-ids-input').value;
        const url = new URL(this.getAttribute('hx-get'), window.location.origin);
        url.searchParams.set('selected_ids', selectedIds);
        this.setAttribute('hx-get', url.toString());
      });
    }
  });
</script>

{% endblock academics_content %}
