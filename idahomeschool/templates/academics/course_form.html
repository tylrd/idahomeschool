{% extends "academics/base.html" %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Add{% endif %} Course{% endblock %}

{% block academics_content %}
<div class="card">
  <div class="card-header">
    <h3 class="mb-0">{% if form.instance.pk %}Edit{% else %}Add{% endif %} Course</h3>
  </div>
  <div class="card-body">
    <form method="post">
      {% csrf_token %}

      <div class="mb-3">
        <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
        <input type="text" name="{{ form.name.name }}" class="form-control{% if form.name.errors %} is-invalid{% endif %}"
               id="{{ form.name.id_for_label }}" value="{{ form.name.value|default:'' }}" required>
        {% if form.name.errors %}
          <div class="invalid-feedback">{{ form.name.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="mb-3">
        <label for="{{ form.grade_level.id_for_label }}" class="form-label">{{ form.grade_level.label }}</label>
        <select name="{{ form.grade_level.name }}" class="form-select{% if form.grade_level.errors %} is-invalid{% endif %}"
                id="{{ form.grade_level.id_for_label }}">
          <option value="">--------- (Grade-agnostic)</option>
          {% for choice in form.fields.grade_level.queryset %}
            <option value="{{ choice.id }}"
                    {% if form.grade_level.value == choice.id|stringformat:"s" %}selected{% endif %}>
              {{ choice.name }}
            </option>
          {% endfor %}
        </select>
        {% if form.grade_level.help_text %}
          <small class="form-text text-muted">{{ form.grade_level.help_text }}</small>
        {% endif %}
        {% if form.grade_level.errors %}
          <div class="invalid-feedback">{{ form.grade_level.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="mb-3">
        <label for="{{ form.course_template.id_for_label }}" class="form-label">{{ form.course_template.label }}</label>
        <select name="{{ form.course_template.name }}" class="form-select{% if form.course_template.errors %} is-invalid{% endif %}"
                id="{{ form.course_template.id_for_label }}" data-template-select>
          <option value="">---------</option>
          {% for choice in form.fields.course_template.queryset %}
            <option value="{{ choice.id }}"
                    {% if form.course_template.value == choice.id|stringformat:"s" %}selected{% endif %}
                    data-resources="{% for resource in choice.suggested_resources.all %}{{ resource.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
              {{ choice.name }}
            </option>
          {% endfor %}
        </select>
        {% if form.course_template.help_text %}
          <small class="form-text text-muted">{{ form.course_template.help_text }}</small>
        {% endif %}
        {% if form.course_template.errors %}
          <div class="invalid-feedback">{{ form.course_template.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="mb-3">
        <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
        <textarea name="{{ form.description.name }}" class="form-control{% if form.description.errors %} is-invalid{% endif %}"
                  id="{{ form.description.id_for_label }}" rows="3">{{ form.description.value|default:'' }}</textarea>
        {% if form.description.errors %}
          <div class="invalid-feedback">{{ form.description.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="mb-3">
        <label class="form-label">Resources</label>

        <!-- Currently Selected Resources -->
        {% if form.instance.pk %}
        <div class="mb-2">
          <strong>Currently Selected:</strong>
          <div id="selected-resources-display" class="mt-1">
            {% for resource in form.instance.resources.all %}
              <span class="badge bg-info me-1">{{ resource.title }}</span>
            {% empty %}
              <span class="text-muted">None</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Tag Filter UI -->
        <div class="mb-2">
          <label class="form-label small mb-1">Filter by Tags:</label>
          <div id="tag-filter-container">
            {% load static %}
            {% comment %}Tags will be loaded here via JavaScript{% endcomment %}
            <p class="text-muted small mb-0">Loading tags...</p>
          </div>
        </div>

        <input
          type="text"
          id="resource-search-input"
          name="search"
          class="form-control mb-2"
          placeholder="Search resources by title, author, or publisher..."
          hx-get="{% url 'academics:resource_search_htmx' %}?field_name=resources"
          hx-trigger="keyup changed delay:300ms, load"
          hx-target="#resource-search-results-resources"
          hx-include="#selected-resources-container, #tag-filter-inputs"
        >

        <!-- Hidden container for selected resource IDs -->
        <div id="selected-resources-container" style="display: none;">
          <input type="hidden" name="selected_ids" value="{% if form.instance.pk %}{% for resource in form.instance.resources.all %}{{ resource.id }}{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}" id="selected-ids-input">
        </div>

        <!-- Hidden container for tag filter IDs -->
        <div id="tag-filter-inputs" style="display: none;"></div>

        <div id="resource-search-results-resources" class="border rounded p-2" style="max-height: 400px; overflow-y: auto;">
          <p class="text-muted">Type to search for resources...</p>
        </div>
        <small class="text-muted">Search and select resources for this course. Use tag filters to narrow results.</small>
        {% if form.resources.errors %}
          <div class="invalid-feedback d-block">{{ form.resources.errors }}</div>
        {% endif %}
      </div>

      <script>
        let selectedTagIds = [];

        // Update selected IDs when checkboxes change
        document.addEventListener('htmx:afterSwap', function(event) {
          if (event.detail.target.id === 'resource-search-results-resources') {
            const checkboxes = document.querySelectorAll('.resource-checkbox');
            checkboxes.forEach(checkbox => {
              checkbox.addEventListener('change', updateSelectedIds);
            });
          }
        });

        function updateSelectedIds() {
          const checkboxes = document.querySelectorAll('.resource-checkbox:checked');
          const ids = Array.from(checkboxes).map(cb => cb.value).join(',');
          document.getElementById('selected-ids-input').value = ids;

          // Trigger another search to update checked states
          const searchInput = document.getElementById('resource-search-input');
          triggerResourceSearch();
        }

        function triggerResourceSearch() {
          const searchInput = document.getElementById('resource-search-input');
          htmx.trigger(searchInput, 'keyup');
        }

        // Auto-populate resources when course template is selected
        document.addEventListener('DOMContentLoaded', function() {
          loadTagFilters();

          const templateSelect = document.querySelector('[data-template-select]');
          if (templateSelect) {
            templateSelect.addEventListener('change', function() {
              const selectedOption = this.options[this.selectedIndex];
              const resourceIds = selectedOption.getAttribute('data-resources');

              if (resourceIds) {
                // Update the hidden input with selected resource IDs
                document.getElementById('selected-ids-input').value = resourceIds;

                // Trigger HTMX to reload the search results with selected items
                const searchInput = document.getElementById('resource-search-input');

                // Use HTMX trigger to force a reload with the new selected_ids
                htmx.ajax('GET', searchInput.getAttribute('hx-get'), {
                  target: '#resource-search-results-resources',
                  swap: 'innerHTML',
                  values: {
                    search: searchInput.value,
                    selected_ids: resourceIds,
                    field_name: 'resources'
                  }
                });
              } else {
                // Clear selections if no template selected
                document.getElementById('selected-ids-input').value = '';
                htmx.ajax('GET', document.getElementById('resource-search-input').getAttribute('hx-get'), {
                  target: '#resource-search-results-resources',
                  swap: 'innerHTML',
                  values: {
                    search: '',
                    selected_ids: '',
                    field_name: 'resources'
                  }
                });
              }
            });
          }

          // Use event delegation for clear tag filters button
          document.getElementById('tag-filter-container').addEventListener('click', function(e) {
            if (e.target.closest('#clear-tag-filters')) {
              selectedTagIds = [];
              updateTagFilterInputs();
              updateTagFilterDisplay();
              triggerResourceSearch();
            }
          });
        });

        function loadTagFilters() {
          // Fetch all tags for this user
          fetch('/academics/tags/autocomplete/?search=', {
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => response.json())
          .then(data => {
            renderTagFilters(data.tags || []);
          })
          .catch(error => {
            console.error('Error loading tags:', error);
          });
        }

        function renderTagFilters(tags) {
          const container = document.getElementById('tag-filter-container');
          let html = '';

          if (tags.length === 0) {
            html = '<p class="text-muted small mb-0">No tags available. <a href="/academics/tags/create/">Create a tag</a> to filter resources.</p>';
          } else {
            tags.forEach(tag => {
              html += `
                <button type="button"
                        class="btn btn-sm btn-outline-primary me-1 mb-1 tag-filter-btn"
                        data-tag-id="${tag.id}"
                        style="border-color: ${tag.color};"
                        onclick="toggleTagFilter(${tag.id}, '${escapeHtml(tag.name)}', '${tag.color}')">
                  <span class="badge" style="background-color: ${tag.color};">${escapeHtml(tag.name)}</span>
                </button>
              `;
            });

            html += `
              <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="clear-tag-filters">
                <i class="bi bi-x-circle"></i> Clear Filters
              </button>
            `;
          }

          container.innerHTML = html;
        }

        function toggleTagFilter(tagId, tagName, tagColor) {
          const index = selectedTagIds.indexOf(tagId);

          if (index > -1) {
            // Remove tag from filters
            selectedTagIds.splice(index, 1);
          } else {
            // Add tag to filters
            selectedTagIds.push(tagId);
          }

          updateTagFilterInputs();
          updateTagFilterDisplay();
          triggerResourceSearch();
        }

        function clearTagFilters() {
          selectedTagIds = [];
          updateTagFilterInputs();
          updateTagFilterDisplay();
          triggerResourceSearch();
        }

        function updateTagFilterInputs() {
          const container = document.getElementById('tag-filter-inputs');
          container.innerHTML = '';

          selectedTagIds.forEach(tagId => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'tag_ids[]';
            input.value = tagId;
            container.appendChild(input);
          });
        }

        function updateTagFilterDisplay() {
          const buttons = document.querySelectorAll('.tag-filter-btn');
          buttons.forEach(button => {
            const tagId = parseInt(button.getAttribute('data-tag-id'));
            if (selectedTagIds.includes(tagId)) {
              button.classList.remove('btn-outline-primary');
              button.classList.add('btn-primary');
            } else {
              button.classList.remove('btn-primary');
              button.classList.add('btn-outline-primary');
            }
          });
        }

        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
      </script>

      <button type="submit" class="btn btn-primary">Save Course</button>
      <a href="{% url 'academics:course_list' %}" class="btn btn-secondary">Cancel</a>
    </form>
  </div>
</div>
{% endblock academics_content %}
