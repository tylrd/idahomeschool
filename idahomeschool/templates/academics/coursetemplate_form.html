{% extends "academics/base.html" %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Add{% endif %} Course Template{% endblock %}

{% block academics_content %}
<div class="mb-6">
  <h1 class="text-3xl font-bold tracking-tight">{% if form.instance.pk %}Edit{% else %}Add{% endif %} Course Template</h1>
</div>

<form method="post" class="form space-y-6">
  {% csrf_token %}

  <div class="grid gap-2">
    <label for="{{ form.name.id_for_label }}" class="text-sm font-medium">{{ form.name.label }}</label>
    <input type="text" name="{{ form.name.name }}" class="{% if form.name.errors %}border-destructive{% endif %}"
           id="{{ form.name.id_for_label }}" value="{{ form.name.value|default:'' }}" required>
    {% if form.name.errors %}
      <p class="text-destructive text-sm">{{ form.name.errors.0 }}</p>
    {% endif %}
  </div>

  <div class="grid gap-2">
    <label for="{{ form.description.id_for_label }}" class="text-sm font-medium">{{ form.description.label }}</label>
    <textarea name="{{ form.description.name }}" class="{% if form.description.errors %}border-destructive{% endif %}"
              id="{{ form.description.id_for_label }}" rows="3">{{ form.description.value|default:'' }}</textarea>
    {% if form.description.errors %}
      <p class="text-destructive text-sm">{{ form.description.errors.0 }}</p>
    {% endif %}
  </div>

  <div class="grid gap-2">
    <label class="text-sm font-medium">Suggested Resources</label>

    <!-- Currently Selected Resources -->
    {% if form.instance.pk %}
    <div class="mb-2">
      <strong>Currently Selected:</strong>
      <div id="selected-resources-display" class="mt-1">
        {% for resource in form.instance.suggested_resources.all %}
          <span class="badge bg-info me-1">{{ resource.title }}</span>
        {% empty %}
          <span class="text-muted-foreground">None</span>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Tag Filter UI -->
    <div class="mb-2">
      <label class="text-sm mb-1">Filter by Tags:</label>
      <div id="tag-filter-container">
        {% load static %}
        {% comment %}Tags will be loaded here via JavaScript{% endcomment %}
        <p class="text-muted-foreground text-sm mb-0">Loading tags...</p>
      </div>
    </div>

    <!-- Search input with Create button -->
    <div class="flex gap-2 mb-2">
      <input
        type="text"
        id="resource-search-input"
        name="search"
        class="flex-1"
        placeholder="Search resources by title, author, or publisher..."
        hx-get="{% url 'academics:resource_search_htmx' %}?field_name=suggested_resources"
        hx-trigger="keyup changed delay:300ms, load"
        hx-target="#resource-search-results-suggested_resources"
        hx-include="#selected-resources-container, #tag-filter-inputs"
      >
      <button
        type="button"
        class="btn"
        id="create-resource-btn"
        hx-get="{% url 'academics:resource_create_modal_htmx' %}?field_name=suggested_resources"
        hx-target="#resource-dialog-content"
        hx-swap="innerHTML"
      >
        <i data-lucide="plus-circle"></i> Create New Resource
      </button>
    </div>

    <!-- Hidden container for selected resource IDs -->
    <div id="selected-resources-container" style="display: none;">
      <input type="hidden" name="selected_ids" value="{% if form.instance.pk %}{% for resource in form.instance.suggested_resources.all %}{{ resource.id }}{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}" id="selected-ids-input">
    </div>

    <!-- Hidden container for tag filter IDs -->
    <div id="tag-filter-inputs" style="display: none;"></div>

    <div id="resource-search-results-suggested_resources" style="max-height: 400px; overflow-y: auto;">
      <p class="text-muted-foreground">Type to search for resources...</p>
    </div>
    <p class="text-muted-foreground text-sm">Search and select resources to suggest for this template. Use tag filters to narrow results.</p>
    {% if form.suggested_resources.errors %}
      <p class="text-destructive text-sm">{{ form.suggested_resources.errors }}</p>
    {% endif %}
  </div>

  <style>
    /* Tag filter hover effect */
    .tag-filter-btn:hover .badge {
      opacity: 1 !important;
      transform: scale(1.05);
    }
  </style>

  <script>
    let selectedTagIds = [];
    let isSearching = false; // Guard against infinite loops

    // Update selected IDs when checkboxes change
    document.addEventListener('htmx:afterSwap', function(event) {
      if (event.detail.target.id === 'resource-search-results-suggested_resources') {
        isSearching = false; // Reset guard after search completes
        const checkboxes = document.querySelectorAll('.resource-checkbox');
        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', updateSelectedIds);
        });
      }
    });

    function updateSelectedIds() {
      const checkboxes = document.querySelectorAll('.resource-checkbox:checked');
      const ids = Array.from(checkboxes).map(cb => cb.value).join(',');
      document.getElementById('selected-ids-input').value = ids;

      // Don't trigger a search - just update the hidden input
      // The search will include these IDs when triggered by other actions
    }

    function triggerResourceSearch() {
      if (isSearching) {
        return; // Prevent infinite loop
      }

      isSearching = true;
      const searchInput = document.getElementById('resource-search-input');

      // Get the URL from the hx-get attribute
      const url = searchInput.getAttribute('hx-get');
      const searchQuery = searchInput.value;
      const selectedIds = document.getElementById('selected-ids-input').value;

      // Get tag IDs from hidden inputs
      const tagInputs = document.querySelectorAll('#tag-filter-inputs input[name="tag_ids[]"]');
      const tagIds = Array.from(tagInputs).map(input => input.value);

      // Use htmx.ajax to make the request with proper parameters
      htmx.ajax('GET', url, {
        target: '#resource-search-results-suggested_resources',
        swap: 'innerHTML',
        values: {
          search: searchQuery,
          selected_ids: selectedIds,
          field_name: 'suggested_resources',
          'tag_ids[]': tagIds
        }
      });
    }

    // Load tag filters on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadTagFilters();

      // Use event delegation for tag filter buttons
      const tagFilterContainer = document.getElementById('tag-filter-container');
      if (tagFilterContainer) {
        tagFilterContainer.addEventListener('click', function(e) {
          // Handle tag filter button clicks
          const tagButton = e.target.closest('.tag-filter-btn');
          if (tagButton) {
            const tagId = parseInt(tagButton.getAttribute('data-tag-id'));
            const tagName = tagButton.getAttribute('data-tag-name');
            const tagColor = tagButton.getAttribute('data-tag-color');
            toggleTagFilter(tagId, tagName, tagColor);
            return;
          }

          // Handle clear filters button
          if (e.target.closest('#clear-tag-filters')) {
            selectedTagIds = [];
            updateTagFilterInputs();
            updateTagFilterDisplay();
            triggerResourceSearch();
          }
        });
      }
    });

    function loadTagFilters() {
      // Fetch all tags for this user
      fetch('/academics/tags/autocomplete/?search=', {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        renderTagFilters(data.tags || []);
      })
      .catch(error => {
        console.error('Error loading tags:', error);
      });
    }

    function renderTagFilters(tags) {
      const container = document.getElementById('tag-filter-container');
      let html = '';

      if (tags.length === 0) {
        html = '<p class="text-muted small mb-0">No tags available. <a href="/academics/tags/create/">Create a tag</a> to filter resources.</p>';
      } else {
        tags.forEach(tag => {
          const textColor = getContrastColor(tag.color);
          html += `
            <button type="button"
                    class="btn btn-sm me-1 mb-1 tag-filter-btn p-0 border-0"
                    data-tag-id="${tag.id}"
                    data-tag-name="${escapeHtml(tag.name)}"
                    data-tag-color="${tag.color}">
              <span class="badge" style="background-color: ${tag.color}; color: ${textColor}; cursor: pointer; opacity: 0.7; transition: all 0.2s ease;">${escapeHtml(tag.name)}</span>
            </button>
          `;
        });

        html += `
          <button type="button" class="btn-outline btn-sm" id="clear-tag-filters">
            <i data-lucide="x-circle"></i> Clear Filters
          </button>
        `;
      }

      container.innerHTML = html;
    }

    function toggleTagFilter(tagId, tagName, tagColor) {
      const index = selectedTagIds.indexOf(tagId);

      if (index > -1) {
        // Remove tag from filters
        selectedTagIds.splice(index, 1);
      } else {
        // Add tag to filters
        selectedTagIds.push(tagId);
      }

      updateTagFilterInputs();
      updateTagFilterDisplay();
      triggerResourceSearch();
    }

    function clearTagFilters() {
      selectedTagIds = [];
      updateTagFilterInputs();
      updateTagFilterDisplay();
      triggerResourceSearch();
    }

    function updateTagFilterInputs() {
      const container = document.getElementById('tag-filter-inputs');
      container.innerHTML = '';

      selectedTagIds.forEach(tagId => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'tag_ids[]';
        input.value = tagId;
        container.appendChild(input);
      });
    }

    function updateTagFilterDisplay() {
      const buttons = document.querySelectorAll('.tag-filter-btn');
      buttons.forEach(button => {
        const tagId = parseInt(button.getAttribute('data-tag-id'));
        const badge = button.querySelector('.badge');

        if (selectedTagIds.includes(tagId)) {
          // Selected: add a subtle ring around the badge
          badge.style.boxShadow = '0 0 0 2px rgba(255, 255, 255, 0.5), 0 0 0 4px currentColor';
          badge.style.opacity = '1';
        } else {
          // Not selected: remove ring and make slightly transparent
          badge.style.boxShadow = 'none';
          badge.style.opacity = '0.7';
        }
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>

  <div class="flex gap-2">
    <button type="submit" class="btn">
      <i data-lucide="save"></i> Save Course Template
    </button>
    <a href="{% url 'academics:coursetemplate_list' %}" class="btn-outline">
      <i data-lucide="x"></i> Cancel
    </a>
  </div>
</form>

<!-- Dialog Container -->
<dialog id="resource-create-dialog" class="dialog w-full sm:max-w-2xl max-h-[90vh]" aria-labelledby="resource-create-dialog-title" onclick="if (event.target === this) this.close()">
  <div id="resource-dialog-content">
    <!-- Content will be loaded via HTMX -->
  </div>
</dialog>

<script>
  // Handle dialog show/hide and resource creation
  const resourceDialog = document.getElementById('resource-create-dialog');

  // Show dialog after HTMX loads content
  document.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'resource-dialog-content') {
      resourceDialog.showModal();
    }

    // Handle successful resource creation
    if (event.detail.target.id === 'resource-search-results-suggested_resources') {
      // Close dialog if it's open
      if (resourceDialog.open) {
        resourceDialog.close();
        // Clear dialog content after closing
        setTimeout(() => {
          document.getElementById('resource-dialog-content').innerHTML = '';
        }, 300);
      }

      // Re-attach event listeners to checkboxes and update selected IDs
      const checkboxes = document.querySelectorAll('.resource-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedIds);
      });

      // Update the hidden input with currently checked values
      updateSelectedIds();
    }
  });

  // Update Create button to include selected_ids in URL
  document.addEventListener('DOMContentLoaded', function() {
    const createBtn = document.getElementById('create-resource-btn');
    if (createBtn) {
      createBtn.addEventListener('click', function() {
        const selectedIds = document.getElementById('selected-ids-input').value;
        const url = new URL(this.getAttribute('hx-get'), window.location.origin);
        url.searchParams.set('selected_ids', selectedIds);
        this.setAttribute('hx-get', url.toString());
      });
    }
  });
</script>

{% endblock academics_content %}
