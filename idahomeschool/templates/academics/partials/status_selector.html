{% comment %}
Partial template for status modal selector (shown when clicking a badge)
Variables expected:
- student: Student object
- date_str: Date as string (Y-m-d format)
- current_status: Current status string (or None)
{% endcomment %}

<div class="modal fade show d-block" id="status-modal" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ student.name }} - {{ date|date:"F j, Y" }}</h5>
        <button type="button"
                class="btn-close"
                onclick="document.getElementById('status-selector-container').innerHTML = ''"
                aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form hx-post="{% url 'academics:attendance_quick_update' student.id date_str %}"
              hx-target="#cell-{{ student.id }}-{{ date_str }}"
              hx-swap="outerHTML">
          {% csrf_token %}

          <div class="d-grid gap-2">
            {% for status in attendance_statuses %}
            <button type="submit"
                    name="status"
                    value="{{ status.code }}"
                    class="btn {% if current_status == status.code %}btn{% else %}btn-outline{% endif %}"
                    style="{% if current_status == status.code %}background-color: {{ status.color }}; border-color: {{ status.color }};{% else %}color: {{ status.color }}; border-color: {{ status.color }};{% endif %} {% if status.color|slice:':4' == '#ffc' or status.color|slice:':4' == '#ff0' or status.color|slice:':4' == '#fff' %}{% if current_status == status.code %}color: #000;{% endif %}{% else %}{% if current_status == status.code %}color: #fff;{% endif %}{% endif %}">
              <strong>{{ status.abbreviation }}</strong> {{ status.label }}
            </button>
            {% endfor %}
          </div>
        </form>

        {% if current_status %}
        <hr class="my-3">
        <div class="d-grid">
          <button type="button"
                  hx-delete="{% url 'academics:attendance_quick_delete' student.id date_str %}"
                  hx-target="#cell-{{ student.id }}-{{ date_str }}"
                  hx-swap="outerHTML"
                  hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                  hx-confirm="Delete this attendance log?"
                  onclick="setTimeout(() => document.getElementById('status-selector-container').innerHTML = '', 100);"
                  class="btn btn-outline-secondary">
            Delete Log
          </button>
        </div>
        {% endif %}

        <hr class="my-3">

        <button type="button"
                class="btn btn-outline-primary w-100"
                data-course-notes-url="{% url 'academics:attendance_course_notes' student.id date_str %}"
                onclick="openCourseNotesFromModal(this)">
          <i class="bi bi-journal-text"></i> Add Course Notes
        </button>

        <div class="mt-2">
          <a href="{% url 'academics:dailylog_entry_date' student.id date_str %}"
             class="btn btn-link w-100">
            Full Entry Form â†’
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Close modal when clicking backdrop
  document.getElementById('status-modal').addEventListener('click', function(event) {
    if (event.target === this) {
      document.getElementById('status-selector-container').innerHTML = '';
    }
  });

  // Function to open course notes modal after closing status selector
  function openCourseNotesModal(url) {
    // Close the status selector modal first
    document.getElementById('status-selector-container').innerHTML = '';

    // Wait a moment for the DOM to update, then fetch course notes modal
    setTimeout(() => {
      fetch(url, {
        headers: {
          'HX-Request': 'true',
          'HX-Target': 'course-notes-modal-container'
        }
      })
      .then(response => response.text())
      .then(html => {
        const container = document.getElementById('course-notes-modal-container');
        container.innerHTML = html;

        // Tell HTMX to process the new modal so hx-* attributes work
        if (typeof htmx !== 'undefined') {
          htmx.process(container);
        }
      })
      .catch(error => console.error('Error loading course notes:', error));
    }, 100);
  }
</script>
