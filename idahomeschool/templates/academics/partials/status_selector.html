{% comment %}
Partial template for status modal selector (shown when clicking a badge)
Variables expected:
- student: Student object
- date_str: Date as string (Y-m-d format)
- current_status: Current status string (or None)
{% endcomment %}

<div class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center" id="status-modal" tabindex="-1" role="dialog">
  <div class="bg-background rounded-lg shadow-lg max-w-md w-full mx-4">
    <div class="flex items-center justify-between p-4 border-b border-border">
      <h2 class="text-lg font-semibold">{{ student.name }} - {{ date|date:"F j, Y" }}</h2>
      <button type="button"
              class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-accent hover:text-accent-foreground h-10 w-10"
              onclick="document.getElementById('status-selector-container').innerHTML = ''"
              aria-label="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>
    <div class="p-5">
      <form hx-post="{% url 'academics:attendance_quick_update' student.id date_str %}"
            hx-target="#cell-{{ student.id }}-{{ date_str }}"
            hx-swap="outerHTML">
        {% csrf_token %}

        <div class="grid gap-3">
          {% for status in attendance_statuses %}
          <button type="submit"
                  name="status"
                  value="{{ status.code }}"
                  class="inline-flex items-center gap-3 rounded-xl text-base font-semibold transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 min-h-[52px] px-5 py-3 border-2 {% if current_status == status.code %}shadow-md{% else %}hover:shadow-sm{% endif %}"
                  style="{% if current_status == status.code %}background-color: {{ status.color }}; border-color: {{ status.color }};{% else %}background-color: transparent; border-color: {{ status.color }}; color: {{ status.color }};{% endif %} {% if status.color|slice:':4' == '#ffc' or status.color|slice:':4' == '#ff0' or status.color|slice:':4' == '#fff' %}{% if current_status == status.code %}color: #000;{% endif %}{% else %}{% if current_status == status.code %}color: #fff;{% endif %}{% endif %}">
            <span class="inline-flex items-center justify-center rounded-full size-8 font-bold text-sm border-2 {% if current_status == status.code %}border-current bg-white/20{% else %}border-current{% endif %}">
              {{ status.abbreviation }}
            </span>
            <span class="flex-1 text-left">{{ status.label }}</span>
            {% if current_status == status.code %}
            <i data-lucide="check-circle" class="size-5"></i>
            {% endif %}
          </button>
          {% endfor %}
        </div>
      </form>

      {% if current_status %}
      <hr class="my-4 border-border">
      <div class="grid gap-2">
        <button type="button"
                hx-delete="{% url 'academics:attendance_quick_delete' student.id date_str %}"
                hx-target="#cell-{{ student.id }}-{{ date_str }}"
                hx-swap="outerHTML"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                hx-confirm="Delete this attendance log?"
                onclick="setTimeout(() => document.getElementById('status-selector-container').innerHTML = '', 100);"
                class="btn-outline text-destructive hover:bg-destructive hover:text-destructive-foreground">
          <i data-lucide="trash-2"></i> Delete Log
        </button>
      </div>
      {% endif %}

      <hr class="my-4 border-border">

      <button type="button"
              class="btn-outline w-full"
              data-course-notes-url="{% url 'academics:attendance_course_notes' student.id date_str %}"
              onclick="openCourseNotesFromModal(this)">
        <i data-lucide="book-open"></i> Add Course Notes
      </button>

      <div class="mt-2">
        <a href="{% url 'academics:dailylog_entry_date' student.id date_str %}"
           class="btn-link w-full text-sm">
          Full Entry Form â†’
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  // Close modal when clicking backdrop
  document.getElementById('status-modal').addEventListener('click', function(event) {
    if (event.target === this) {
      document.getElementById('status-selector-container').innerHTML = '';
    }
  });

  // Function to open course notes modal after closing status selector
  function openCourseNotesModal(url) {
    // Close the status selector modal first
    document.getElementById('status-selector-container').innerHTML = '';

    // Wait a moment for the DOM to update, then fetch course notes modal
    setTimeout(() => {
      fetch(url, {
        headers: {
          'HX-Request': 'true',
          'HX-Target': 'course-notes-modal-container'
        }
      })
      .then(response => response.text())
      .then(html => {
        const container = document.getElementById('course-notes-modal-container');
        container.innerHTML = html;

        // Tell HTMX to process the new modal so hx-* attributes work
        if (typeof htmx !== 'undefined') {
          htmx.process(container);
        }
      })
      .catch(error => console.error('Error loading course notes:', error));
    }, 100);
  }
</script>
