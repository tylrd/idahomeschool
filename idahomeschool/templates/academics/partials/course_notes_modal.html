{% load academics_extras %}
{% comment %}
Partial template for course notes modal
Variables expected:
- student: Student object
- date: Date object
- date_str: Date as string (Y-m-d format)
- daily_log: DailyLog object (can be None)
- enrollments: List of course enrollments for the student
- course_notes: Dict mapping enrollment_id to CourseNote notes text
{% endcomment %}

<!-- Modal backdrop and container -->
<div class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center"
     id="courseNotesModal"
     tabindex="-1"
     aria-modal="true"
     role="dialog">
  <div class="bg-background rounded-lg shadow-lg max-w-3xl w-full max-h-[90vh] flex flex-col mx-4">
    <div class="flex items-center justify-between p-4 border-b border-border">
      <h2 class="text-lg font-semibold">Course Notes - {{ student.name }}</h2>
      <button type="button"
              class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-accent hover:text-accent-foreground h-10 w-10"
              onclick="document.getElementById('course-notes-modal-container').innerHTML = ''"
              aria-label="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>

    <form hx-post="{% url 'academics:attendance_save_course_notes' student.id date_str %}"
          hx-target="#course-notes-modal-container"
          hx-swap="innerHTML"
          class="flex flex-col flex-1 overflow-hidden">
      {% csrf_token %}

      <div class="flex-1 overflow-y-auto p-4 space-y-4">
        <p class="text-muted-foreground">
          <i class="bi bi-calendar3"></i> {{ date|date:"l, F j, Y" }}
        </p>

        {% if not daily_log %}
        <div class="alert">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3" />
            <path d="M12 9v4" />
            <path d="M12 17h.01" />
          </svg>
          <h3><i class="bi bi-exclamation-triangle"></i> No attendance log yet.</h3>
          <section>You can add course notes, but remember to mark attendance status too.</section>
        </div>
        {% endif %}

        {% if daily_log and daily_log.general_notes %}
        <div class="space-y-2">
          <label class="font-semibold">General Notes:</label>
          <p class="text-muted-foreground">{{ daily_log.general_notes }}</p>
        </div>
        <hr class="border-border">
        {% endif %}

        {% if enrollments %}
          <h3 class="text-base font-semibold">Course-Specific Notes:</h3>
          {% for enrollment in enrollments %}
            <div class="grid gap-2">
              <label for="enrollment-{{ enrollment.id }}">
                <strong>{{ enrollment.course.name }}</strong>
                <span class="badge-secondary ml-2">{{ enrollment.school_year.name }}</span>
                {% if enrollment.course.description %}
                  <small class="text-muted-foreground block text-sm mt-1">{{ enrollment.course.description|truncatewords:15 }}</small>
                {% endif %}
              </label>
              <textarea id="enrollment-{{ enrollment.id }}"
                        name="enrollment_{{ enrollment.id }}"
                        rows="3"
                        placeholder="What did {{ student.name|truncatewords:1 }} work on in {{ enrollment.course.name }}?">{% if course_notes|get_item:enrollment.id %}{{ course_notes|get_item:enrollment.id }}{% endif %}</textarea>
            </div>
          {% endfor %}
        {% else %}
          <div class="alert">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10" />
              <line x1="12" x2="12" y1="8" y2="12" />
              <line x1="12" x2="12.01" y1="16" y2="16" />
            </svg>
            <h3><i class="bi bi-info-circle"></i> No enrollments found</h3>
            <section>
              for {{ student.name }} in the active school year.
              <a href="{% url 'academics:course_create' %}" class="underline">Add a course</a> and enroll the student to start logging course-specific notes.
            </section>
          </div>
        {% endif %}
      </div>

      <div class="flex items-center justify-end gap-2 p-4 border-t border-border">
        <button type="button"
                class="btn-secondary"
                onclick="document.getElementById('course-notes-modal-container').innerHTML = ''">
          Cancel
        </button>
        {% if enrollments %}
        <button type="submit" class="btn-primary">
          <i class="bi bi-save"></i> Save Course Notes
        </button>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<script>
  // Close modal on backdrop click
  document.getElementById('courseNotesModal').addEventListener('click', function(event) {
    if (event.target === this) {
      document.getElementById('course-notes-modal-container').innerHTML = '';
    }
  });

  // Close on Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      const container = document.getElementById('course-notes-modal-container');
      if (container && container.innerHTML.trim() !== '') {
        container.innerHTML = '';
      }
    }
  });
</script>
