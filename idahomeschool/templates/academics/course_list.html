{% extends "academics/base.html" %}
{% load static %}

{% block title %}Courses{% endblock %}

{% block academics_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Courses</h1>
  <a href="{% url 'academics:course_create' %}" class="btn btn-success">Add Course</a>
</div>

<div class="card mb-3">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-4">
        <input type="text" name="search" class="form-control" placeholder="Search courses by name..." value="{{ search_query }}">
      </div>
      <div class="col-md-3">
        <select name="grade" class="form-select">
          <option value="">All Grades</option>
          {% for grade in grade_levels %}
            <option value="{{ grade.id }}" {% if grade_filter == grade.id|stringformat:"s" %}selected{% endif %}>
              {{ grade.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
      {% if search_query or grade_filter %}
      <div class="col-md-2">
        <a href="{% url 'academics:course_list' %}" class="btn btn-secondary w-100">Clear</a>
      </div>
      {% endif %}
    </form>
  </div>
</div>

{% if grouped_courses or unassigned_courses %}
<!-- Grouped by Grade Level -->
{% for grade_level, courses_list in grouped_courses %}
<div class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <button class="btn btn-link text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#grade-{{ grade_level.id }}" aria-expanded="true" aria-controls="grade-{{ grade_level.id }}">
        <i class="bi bi-chevron-down"></i> {{ grade_level.name }}
      </button>
      <span class="badge bg-secondary ms-2">{{ courses_list|length }} course{{ courses_list|length|pluralize }}</span>
    </h5>
  </div>
  <div id="grade-{{ grade_level.id }}" class="collapse show">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead>
            <tr>
              <th>Course Name</th>
              <th>Template</th>
              <th>Enrollments</th>
              <th>Resources</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for course in courses_list %}
            <tr>
              <td><a href="{% url 'academics:course_detail' course.pk %}">{{ course.name }}</a></td>
              <td>
                {% if course.course_template %}
                  <a href="{% url 'academics:coursetemplate_detail' course.course_template.pk %}">{{ course.course_template.name }}</a>
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ course.enrollments.count }}</td>
              <td>{{ course.resources.count }}</td>
              <td>
                <a href="{% url 'academics:course_update' course.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
                <a href="{% url 'academics:course_delete' course.pk %}" class="btn btn-sm btn-outline-danger">Delete</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<!-- Unassigned Courses (no grade level) -->
{% if unassigned_courses %}
<div class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <button class="btn btn-link text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#unassigned-courses" aria-expanded="true" aria-controls="unassigned-courses">
        <i class="bi bi-chevron-down"></i> Unassigned Grade Level
      </button>
      <span class="badge bg-secondary ms-2">{{ unassigned_courses|length }} course{{ unassigned_courses|length|pluralize }}</span>
    </h5>
  </div>
  <div id="unassigned-courses" class="collapse show">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead>
            <tr>
              <th>Course Name</th>
              <th>Template</th>
              <th>Enrollments</th>
              <th>Resources</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for course in unassigned_courses %}
            <tr>
              <td><a href="{% url 'academics:course_detail' course.pk %}">{{ course.name }}</a></td>
              <td>
                {% if course.course_template %}
                  <a href="{% url 'academics:coursetemplate_detail' course.course_template.pk %}">{{ course.course_template.name }}</a>
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ course.enrollments.count }}</td>
              <td>{{ course.resources.count }}</td>
              <td>
                <a href="{% url 'academics:course_update' course.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
                <a href="{% url 'academics:course_delete' course.pk %}" class="btn btn-sm btn-outline-danger">Delete</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% else %}
<div class="alert alert-info">
  <h4>No courses found</h4>
  {% if search_query %}
    <p>No courses match your search criteria.</p>
    <a href="{% url 'academics:course_list' %}" class="btn btn-secondary">Clear Search</a>
  {% else %}
    <p>Get started by adding your first course.</p>
    <a href="{% url 'academics:course_create' %}" class="btn btn-primary">Add Course</a>
  {% endif %}
</div>
{% endif %}
{% endblock academics_content %}

{% block extra_js %}
<style>
  .btn-link i {
    transition: transform 0.2s ease;
  }
  .btn-link[aria-expanded="false"] i {
    transform: rotate(-90deg);
  }
</style>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle chevron rotation on collapse/expand
    const collapseElements = document.querySelectorAll('.collapse');
    collapseElements.forEach(function(element) {
      element.addEventListener('show.bs.collapse', function() {
        const button = document.querySelector('[data-bs-target="#' + element.id + '"]');
        if (button) {
          button.setAttribute('aria-expanded', 'true');
        }
      });
      element.addEventListener('hide.bs.collapse', function() {
        const button = document.querySelector('[data-bs-target="#' + element.id + '"]');
        if (button) {
          button.setAttribute('aria-expanded', 'false');
        }
      });
    });
  });
</script>
{% endblock extra_js %}
