{% extends "academics/base.html" %}
{% load static %}

{% block title %}School Years{% endblock %}

{% block academics_content %}
<div class="flex justify-between items-center mb-6">
  <h1 class="text-3xl font-bold tracking-tight">School Years</h1>
  <a href="{% url 'academics:schoolyear_create' %}" class="btn-outline">
    <i data-lucide="plus-circle"></i> Add School Year
  </a>
</div>

{% if school_years %}
<div class="relative w-full overflow-x-auto">
  <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th class="text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for year in school_years %}
        <tr id="schoolyear-row-{{ year.pk }}">
          <td>
            <div class="flex items-center gap-2">
              <a href="{% url 'academics:schoolyear_detail' year.pk %}" class="link font-medium">{{ year.name }}</a>
              {% if year.is_active %}
              <span class="badge badge-sm">Active</span>
              {% endif %}
            </div>
          </td>
          <td class="text-muted-foreground">{{ year.start_date }}</td>
          <td class="text-muted-foreground">{{ year.end_date }}</td>
          <td>
            <div class="flex gap-1 justify-end">
              <button type="button"
                      onclick="document.getElementById('dialog-edit-{{ year.pk }}').showModal()"
                      class="btn-icon-outline size-8">
                <i data-lucide="pencil"></i>
              </button>
              <button type="button"
                      onclick="document.getElementById('dialog-delete-{{ year.pk }}').showModal()"
                      class="btn-icon-outline size-8 text-destructive hover:bg-destructive/10">
                <i data-lucide="trash-2"></i>
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Dialogs - placed outside table structure -->
  {% for year in school_years %}
    <!-- Edit Dialog -->
    <dialog id="dialog-edit-{{ year.pk }}"
            class="dialog w-full sm:max-w-[500px]"
            aria-labelledby="dialog-edit-{{ year.pk }}-title"
            onclick="if (event.target === this) this.close()">
      <div>
        <header>
          <h2 id="dialog-edit-{{ year.pk }}-title">Edit School Year</h2>
          <p>Update the details for {{ year.name }}.</p>
        </header>

        <form hx-post="{% url 'academics:schoolyear_update' year.pk %}"
              hx-target="#schoolyear-row-{{ year.pk }}"
              hx-swap="outerHTML"
              hx-on::after-request="if(event.detail.successful) this.closest('dialog').close()"
              class="form">
          {% csrf_token %}

          <section class="space-y-4">
            <div class="grid gap-2">
              <label for="edit-name-{{ year.pk }}" class="text-sm font-medium">Name</label>
              <input type="text" name="name" id="edit-name-{{ year.pk }}" value="{{ year.name }}" required>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="grid gap-2">
                <label for="edit-start-date-{{ year.pk }}" class="text-sm font-medium">Start Date</label>
                <input type="date" name="start_date" id="edit-start-date-{{ year.pk }}" value="{{ year.start_date|date:'Y-m-d' }}" required>
              </div>

              <div class="grid gap-2">
                <label for="edit-end-date-{{ year.pk }}" class="text-sm font-medium">End Date</label>
                <input type="date" name="end_date" id="edit-end-date-{{ year.pk }}" value="{{ year.end_date|date:'Y-m-d' }}" required>
              </div>
            </div>

            <div class="grid gap-2">
              <label class="font-normal">
                <input type="checkbox" name="is_active" id="edit-is-active-{{ year.pk }}" {% if year.is_active %}checked{% endif %}>
                Set as active school year
              </label>
              <p class="text-muted-foreground text-sm">Only one school year can be active at a time.</p>
            </div>
          </section>

          <footer>
            <button type="button" class="btn-outline" onclick="this.closest('dialog').close()">Cancel</button>
            <button type="button"
                    class="btn"
                    onclick="this.closest('dialog').querySelector('form').requestSubmit()">
              Save changes
            </button>
          </footer>
        </form>

        <button type="button" aria-label="Close dialog" onclick="this.closest('dialog').close()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x">
            <path d="M18 6 6 18" />
            <path d="m6 6 12 12" />
          </svg>
        </button>
      </div>
    </dialog>

    <!-- Delete Dialog -->
    <dialog id="dialog-delete-{{ year.pk }}"
            class="dialog w-full sm:max-w-[425px]"
            aria-labelledby="dialog-delete-{{ year.pk }}-title"
            aria-describedby="dialog-delete-{{ year.pk }}-description"
            onclick="if (event.target === this) this.close()">
      <div>
        <header>
          <h2 id="dialog-delete-{{ year.pk }}-title">Delete School Year</h2>
          <p id="dialog-delete-{{ year.pk }}-description">Are you sure you want to delete {{ year.name }}?</p>
        </header>

        <section>
          {% include "academics/partials/schoolyear_delete_warning.html" %}
        </section>

        <footer>
          <button type="button" class="btn-outline" onclick="this.closest('dialog').close()">Cancel</button>
          <form method="post"
                action="{% url 'academics:schoolyear_delete' year.pk %}"
                hx-post="{% url 'academics:schoolyear_delete' year.pk %}"
                hx-target="#schoolyear-row-{{ year.pk }}"
                hx-swap="outerHTML swap:1s"
                style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn bg-destructive hover:bg-destructive/90">Delete</button>
          </form>
        </footer>

        <button type="button" aria-label="Close dialog" onclick="this.closest('dialog').close()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x">
            <path d="M18 6 6 18" />
            <path d="m6 6 12 12" />
          </svg>
        </button>
      </div>
    </dialog>
  {% endfor %}

{% else %}
<div class="p-12 text-center">
  <div class="mx-auto flex max-w-md flex-col items-center gap-2">
    <div class="flex size-12 items-center justify-center rounded-full bg-muted">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-muted-foreground">
        <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
        <line x1="16" x2="16" y1="2" y2="6"/>
        <line x1="8" x2="8" y1="2" y2="6"/>
        <line x1="3" x2="21" y1="10" y2="10"/>
      </svg>
    </div>
    <h2 class="text-xl font-semibold">No school years yet</h2>
    <p class="text-sm text-muted-foreground mb-2">Get started by creating your first school year to track attendance and courses.</p>
    <a href="{% url 'academics:schoolyear_create' %}" class="btn">
      <i data-lucide="plus-circle"></i> Create School Year
    </a>
  </div>
</div>
{% endif %}

{% endblock academics_content %}
