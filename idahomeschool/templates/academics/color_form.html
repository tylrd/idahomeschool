{% extends "academics/base.html" %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}Edit Color{% else %}Add Color{% endif %}{% endblock %}

{% block academics_content %}
<div class="card">
  <header>
    <h2>{% if form.instance.pk %}Edit Color{% else %}Add Color{% endif %}</h2>
  </header>
  <section>
    <form method="post">
      {% csrf_token %}

      <div class="grid gap-2">
        <label for="id_color">Color *</label>
        <div class="flex gap-2">
          <input type="color" id="id_color" name="color" value="{{ form.color.value|default:'#007bff' }}" required>
          <input type="text" class="flex-1" id="id_color_hex" placeholder="#007bff" maxlength="7" pattern="^#[0-9A-Fa-f]{6}$" value="{{ form.color.value|default:'#007bff' }}">
        </div>
        <p class="text-muted-foreground text-sm">Pick a color or enter a hex color code (e.g., #007bff)</p>
      </div>

      <div class="grid gap-2 mt-4">
        <label for="id_name">Name (optional)</label>
        <input type="text" id="id_name" name="name" value="{{ form.name.value|default:'' }}" placeholder="e.g., Ocean Blue" maxlength="50">
        <p class="text-muted-foreground text-sm">Optional name to help you remember this color</p>
      </div>

      <div class="grid gap-2 mt-4">
        <label>Add to Palettes (optional)</label>
        <p class="text-muted-foreground text-sm mb-2">Select which palette(s) this color should be added to</p>
        {% for palette in form.fields.palettes.queryset %}
        <div class="flex items-center gap-2">
          <input type="checkbox" name="palettes" value="{{ palette.pk }}" id="palette_{{ palette.pk }}"
                 {% if form.instance.pk and palette in form.instance.palettes.all %}checked{% endif %}>
          <label for="palette_{{ palette.pk }}">
            {{ palette.name }}
            {% if palette.is_active %}
            <span class="badge bg-success ms-1">Active</span>
            {% endif %}
          </label>
        </div>
        {% endfor %}
        {% if not form.fields.palettes.queryset.exists %}
        <div class="alert mt-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10" />
            <line x1="12" x2="12" y1="8" y2="12" />
            <line x1="12" x2="12.01" y1="16" y2="16" />
          </svg>
          <section>
            No palettes available. <a href="{% url 'academics:color_palette_create' %}">Create a palette</a> first.
          </section>
        </div>
        {% endif %}
      </div>

      <div class="flex gap-2 mt-6">
        <button type="submit" class="btn-primary">{% if form.instance.pk %}Save Changes{% else %}Add Color{% endif %}</button>
        <a href="{% url 'academics:color_palette_list' %}" class="btn-secondary">Cancel</a>
      </div>
    </form>
  </section>
</div>

<script>
  // Sync color picker with hex input
  const colorPicker = document.getElementById('id_color');
  const colorHex = document.getElementById('id_color_hex');

  colorPicker.addEventListener('input', function() {
    colorHex.value = this.value;
  });

  colorHex.addEventListener('input', function() {
    const hex = this.value.trim();
    if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
      colorPicker.value = hex;
    }
  });

  // Initialize hex input with color picker value
  colorHex.value = colorPicker.value;
</script>
{% endblock academics_content %}
